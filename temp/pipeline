variables:
    # Variablen mit description werden unter "Run Pipeline" in Gitlab UI angezeigt
    XELOS_MAJOR_VERSION:
        value: "12"
    XELOS_IMAGE_TAG:
        value: "Tag value"
        description: "Name des Tags vom anzureichernden Xelos-Image"    
    UBUNTU_SRC_IMAGE_TAG:
        value: "24.04"
        description: "Name des Tags vom verwendeten Ubuntu-Image für das Maptiler-Image"
    MAPTILER_TRG_IMAGE_TAG:
        value: "Tag value"
        description: "Name des Tags vom gebauten Maptiler-Image"
    CI_DEBUG_TRACE: "false"

# Vault spezifische Variablen, damt ein JWT-Flow mit Vault ermöglicht wird
    VAULT_SERVER_URL: ${VAULT_SERVER_URL}
    VAULT_AUTH_ROLE: ${VAULT_AUTH_ROLE}
    VAULT_AUTH_PATH: ${VAULT_AUTH_PATH}
    VAULT_NAMESPACE: ${VAULT_NAMESPACE}
    VAULT_MOUNT_PATH: "${VAULT_NAMESPACE}-secrets"

    
stages:
  - order
  - wait
  - build


order-xelosImage-job:
  image: harbor.sde.svc.intdev.cloud.bwi.intranet-bw.de/socn/ansible:2.18.6
  tags:
    - sde-common

  stage: order

  id_tokens:
    VAULT_ID_TOKEN:
      aud: ${VAULT_SERVER_URL}

  secrets:
    DEPLOYMENT_ID:
      vault: gitlab/deployment_id@${VAULT_MOUNT_PATH}
      token: ${VAULT_ID_TOKEN}
      file: false

    DEPLOYMENT_NAME:
      vault: gitlab/deployment_name@${VAULT_MOUNT_PATH}
      token: ${VAULT_ID_TOKEN}
      file: false

    PROJECT_ID:
      vault: gitlab/project_id@${VAULT_MOUNT_PATH}
      token: ${VAULT_ID_TOKEN}
      file: false

    PROJECT_NAMESPACE:
      vault: gitlab/project_namespace@${VAULT_MOUNT_PATH}
      token: ${VAULT_ID_TOKEN}
      file: false

    VRA_HOSTNAME:
      vault: gitlab/vra_hostname@${VAULT_MOUNT_PATH}
      token: ${VAULT_ID_TOKEN}
      file: false

    VRA_USERNAME:
      vault: gitlab/vra_username@${VAULT_MOUNT_PATH}
      token: ${VAULT_ID_TOKEN}
      file: false

    VRA_PASSWORD:
      vault: gitlab/vra_password@${VAULT_MOUNT_PATH}
      token: ${VAULT_ID_TOKEN}
      file: false

  script:
    - export XELOS_IMAGE="registry.xelos.net/bwi/xelos-${XELOS_MAJOR_VERSION}:${XELOS_IMAGE_TAG}"
    - cd ansible
    - ansible-playbook playbook.yml -e "new_xelos_image=${XELOS_IMAGE}" -e "vra_hostname=${VRA_HOSTNAME}" -e "vra_username=${VRA_USERNAME}" -e "vra_password=${VRA_PASSWORD}" -e "project_namespace=${PROJECT_NAMESPACE}" -e "project_id=${PROJECT_ID}" -e "deployment_name=${DEPLOYMENT_NAME}" -e "deployment_id=${DEPLOYMENT_ID}"

wait-for-image:
  image: harbor.sde.svc.intdev.cloud.bwi.intranet-bw.de/socn/curl:8.14.1
  tags:
    - sde-common


  stage: wait

  id_tokens:
    VAULT_ID_TOKEN:
      aud: ${VAULT_SERVER_URL}

  secrets:
    NEXUS_USER:
      vault: gitlab/nexus_username@${VAULT_MOUNT_PATH}
      token: ${VAULT_ID_TOKEN}
      file: false
    NEXUS_PASSWORD:
      vault: gitlab/nexus_password@${VAULT_MOUNT_PATH}
      token: ${VAULT_ID_TOKEN}
      file: false


  script:
    - |
      NEXUS_IMAGE="registry.xelos.net/bwi/xelos-${XELOS_MAJOR_VERSION}:${XELOS_IMAGE_TAG}"
      NEXUS_SCANNED_REPO="$IntDev_Nexus_ScannedRepo"
      MAX_WAIT=1800  # 30m
      SLEEP_INTERVAL=30  # 30s
      echo "https://${NEXUS_SCANNED_REPO}/v2/registry.xelos.net/bwi/xelos-${XELOS_MAJOR_VERSION}/manifests/${XELOS_IMAGE_TAG}"
      echo "Warten bis Image: ${NEXUS_IMAGE} im Scanned Nexus Repo verfügbar ist  ."

      ELAPSED=0
      while [ $ELAPSED -lt $MAX_WAIT ]; do
        if curl -f -s -u "${NEXUS_USER}:${NEXUS_PASSWORD}" \
          "https://${NEXUS_SCANNED_REPO}/v2/registry.xelos.net/bwi/xelos-${XELOS_MAJOR_VERSION}/manifests/${XELOS_IMAGE_TAG}" \
          | grep -q "schemaVersion"; then
          echo "Image bisher nicht gefunden im Scanned Nexus Repo"
          exit 0
        fi

        echo "Image noch nicht verfügbar. Warten... ("$ELAPSED/$MAX_WAIT seconds")"
        sleep $SLEEP_INTERVAL
        ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
      done

      echo "Timeout_ Image konnte nicht im Nexus gefunden werden innerhalb $MAX_WAIT Sekunden"
      exit 1

  needs:
      - order-xelosImage-job

---



script:
    - |
      NEXUS_IMAGE="registry.xelos.net/bwi/xelos-${XELOS_MAJOR_VERSION}:${XELOS_IMAGE_TAG}"
      # URL zusammenbauen (Variable IntDev_Nexus_ScannedRepo muss gesetzt sein!)
      NEXUS_URL="https://${IntDev_Nexus_ScannedRepo}/v2/registry.xelos.net/bwi/xelos-${XELOS_MAJOR_VERSION}/manifests/${XELOS_IMAGE_TAG}"
      
      MAX_WAIT=1800  # 30m
      SLEEP_INTERVAL=30  # 30s
      
      echo "Prüfe URL: ${NEXUS_URL}"
      echo "Warten bis Image: ${NEXUS_IMAGE} im Scanned Nexus Repo verfügbar ist..."

      ELAPSED=0
      while [ $ELAPSED -lt $MAX_WAIT ]; do
        # Wir holen nur den HTTP Status Code (-w %{http_code}) und verwerfen den Output (-o /dev/null)
        # WICHTIG: Der Accept Header ist notwendig für Docker V2 API!
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
          -u "${NEXUS_USER}:${NEXUS_PASSWORD}" \
          -H "Accept: application/vnd.docker.distribution.manifest.v2+json" \
          -H "Accept: application/vnd.docker.distribution.manifest.list.v2+json" \
          "${NEXUS_URL}")

        if [ "$HTTP_CODE" -eq 200 ]; then
          echo "SUCCESS: Image im Nexus gefunden (HTTP 200)."
          exit 0
        fi

        # Optional: Debugging Ausgabe, falls es nicht 404 ist (z.B. 401 Unauthorized oder 500)
        if [ "$HTTP_CODE" -ne 404 ]; then
             echo "WARNUNG: Unerwarteter Status Code: $HTTP_CODE"
        fi

        echo "Image noch nicht verfügbar (Status: $HTTP_CODE). Warten... ($ELAPSED/$MAX_WAIT seconds)"
        sleep $SLEEP_INTERVAL
        ELAPSED=$((ELAPSED + SLEEP_INTERVAL))
      done

      echo "TIMEOUT: Image wurde nicht innerhalb von $MAX_WAIT Sekunden gefunden."
      exit 1
